import pandas as pd
import xarray as xr
import numpy as np
from typing import List, Dict, Any, Union
from dataclasses import dataclass
from sklearn.neighbors import BallTree
import pyarrow.parquet as pq
import pyarrow as pa
import math

# --- Configuration Model (Simplified) ---
@dataclass
class MatchupConfig:
        """Configuration for the collocation process."""
            time_tolerance_sec: float = 1800.0  # Default 30 minutes
                space_tolerance_km: float = 5.0     # Default 5 km
                    primary_variables: List[str] = None
                        secondary_variables: List[str] = None
                            max_secondary_per_primary: int = 1  # 1: find nearest

                            # --- Utility Functions ---

                            def haversine_km(lat1, lon1, lat2, lon2) -> float:
                                    """Calculates the great-circle distance between two points on the sphere."""
                                        R = 6371.0  # Radius of Earth in kilometers
                                            # Note: For array-based distance, use the BallTree's built-in metric
                                                phi1, phi2 = np.radians(lat1), np.radians(lat2)
                                                    dphi = np.radians(lat2 - lat1)
                                                        dlambda = np.radians(lon2 - lon1)
                                                            
                                                                a = (np.sin(dphi / 2.0)**2 +
                                                                              np.cos(phi1) * np.cos(phi2) * np.sin(dlambda / 2.0)**2)
                                                                    return 2.0 * R * np.arcsin(np.sqrt(a))

                                                                def degrees_to_radians(degrees: np.ndarray) -> np.ndarray:
                                                                        """Converts degrees (lat/lon) to radians for BallTree."""
                                                                            return np.radians(degrees)

                                                                        # --- Core I/O Functions ---

                                                                        def load_data(paths: Union[str, List[str]], cfg: MatchupConfig, is_primary: bool) -> pd.DataFrame:
                                                                                """Loads and flattens primary or secondary data from NetCDF/HDF (via xarray/pandas)."""
                                                                                    if isinstance(paths, str):
                                                                                                paths = [paths]
                                                                                                    
                                                                                                        frames = []
                                                                                                            
                                                                                                                for path in paths:
                                                                                                                            try:
                                                                                                                                            ds = xr.open_dataset(path)
                                                                                                                                                        # Flatten to DataFrame, resetting coordinates to columns
                                                                                                                                                                    df = ds.to_dataframe().reset_index()
                                                                                                                                                                                
                                                                                                                                                                                            # Use variables specified in config
                                                                                                                                                                                                        vars_ = cfg.primary_variables if is_primary else cfg.secondary_variables
                                                                                                                                                                                                                    
                                                                                                                                                                                                                                # Essential columns: time, lat, lon
                                                                                                                                                                                                                                            # Note: You may need to rename columns based on specific file formats (e.g., SeaBASS vs L2 NetCDF)
                                                                                                                                                                                                                                                        cols = ['time', 'lat', 'lon'] + (vars_ or [])
                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                # Select and clean up. Dropna is for simplicity here,
                                                                                                                                                                                                                                                                                            # proper QC happens later, but drop missing time/lat/lon is safe.
                                                                                                                                                                                                                                                                                                        df = df[cols].dropna(subset=['time', 'lat', 'lon'])
                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                # Add granule ID for provenance
                                                                                                                                                                                                                                                                                                                                            df[f'{"primary" if is_primary else "secondary"}_granule_id'] = path
                                                                                                                                                                                                                                                                                                                                                        frames.append(df)
                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                            except Exception as e:
                                                                                                                                                                                                                                                                                                                                                                                            print(f"Error loading {path}: {e}")
                                                                                                                                                                                                                                                                                                                                                                                                        continue

                                                                                                                                                                                                                                                                                                                                                                                                        if not frames:
                                                                                                                                                                                                                                                                                                                                                                                                                    return pd.DataFrame()
                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                    return pd.concat(frames, ignore_index=True)

                                                                                                                                                                                                                                                                                                                                                                                                                # --- Matchup Engine ---

                                                                                                                                                                                                                                                                                                                                                                                                                def run_matchup_engine(
                                                                                                                                                                                                                                                                                                                                                                                                                            primary_path: str,
                                                                                                                                                                                                                                                                                                                                                                                                                                secondary_paths: List[str],
                                                                                                                                                                                                                                                                                                                                                                                                                                    cfg: MatchupConfig,
                                                                                                                                                                                                                                                                                                                                                                                                                                        output_path: str
                                                                                                                                                                                                                                                                                                                                                                                                                                        ) -> None:
                                                                                                                                                                                                                                                                                                                                                                                                                        """
                                                                                                                                                                                                                                                                                                                                                                                                                            Performs the core spatiotemporal collocation and writes output to Parquet.
                                                                                                                                                                                                                                                                                                                                                                                                                                """
                                                                                                                                                                                                                                                                                                                                                                                                                                    # 1. Load Data
                                                                                                                                                                                                                                                                                                                                                                                                                                        primary = load_data(primary_path, cfg, is_primary=True)
                                                                                                                                                                                                                                                                                                                                                                                                                                            secondary = load_data(secondary_paths, cfg, is_primary=False)

                                                                                                                                                                                                                                                                                                                                                                                                                                                if primary.empty or secondary.empty:
                                                                                                                                                                                                                                                                                                                                                                                                                                                            print("No data loaded. Skipping matchup.")
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    pd.DataFrame().to_parquet(output_path) # Write empty file
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return

                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # 2. Build Spatial Index on Secondary Data
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # BallTree requires (lat, lon) to be in RADIANS, and uses the haversine metric
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    secondary_coords_rad = np.vstack([
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                degrees_to_radians(secondary['lat'].values),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        degrees_to_radians(secondary['lon'].values)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]).T
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Initialize the spatial index for fast nearest-neighbor lookups
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            tree = BallTree(secondary_coords_rad, metric='haversine')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                R_earth_km = 6371.0

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # 3. Search and Collocate
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        rows = []
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                for i, p in primary.iterrows():
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p_time = p['time'].timestamp()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            # A. Filter Secondary by Time Tolerance (Temporal Subsetting)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Use pandas/numpy to quickly mask by time
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            secondary_times_sec = secondary['time'].apply(lambda t: t.timestamp())
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    dt_sec = np.abs(secondary_times_sec - p_time)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Get indices of secondary points within the time tolerance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            time_mask = dt_sec <= cfg.time_tolerance_sec
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    cand_indices = secondary.index[time_mask]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if cand_indices.empty:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    continue

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # B. Perform Spatial Search on Time-Filtered Subset
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # The primary point coordinates must also be converted to radians for the query
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        p_coords_rad = degrees_to_radians(np.array([p['lat'], p['lon']]))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Query the BallTree for neighbors within the distance tolerance (in radians)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # haversine(d_km) = d_rad * R_earth => d_rad = d_km / R_earth
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        query_radius_rad = cfg.space_tolerance_km / R_earth_km

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Find all secondary points within the radius for the *current* primary point
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # tree.query_radius returns indices relative to the FULL secondary dataset, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # so we must combine this with the time_mask.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # NOTE: For simplicity, the full implementation needs to query the tree
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # built ONLY from the time-filtered indices, or use a spatial index that can
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # handle index-mapping cleanly.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # For this skeleton, we'll revert to a clean, two-step search:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Re-build a temporary tree only on the time-filtered candidates for correctness
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cand_secondary = secondary.loc[cand_indices]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cand_coords_rad = np.vstack([
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        degrees_to_radians(cand_secondary['lat'].values),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    degrees_to_radians(cand_secondary['lon'].values)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ]).T
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                cand_tree = BallTree(cand_coords_rad, metric='haversine')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Query this smaller tree
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dists_rad, ind_cands = cand_tree.query(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            p_coords_rad.reshape(1, -1),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        k=cfg.max_secondary_per_primary,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return_distance=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                dualtree=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            breadth_first=True,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    )

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # C. Filter Results and Assemble Row
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Indices returned are relative to 'cand_secondary'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for k in range(ind_cands.shape[1]):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Check if an actual neighbor was found (index won't be -1)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if ind_cands[0, k] < len(cand_secondary):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        s_index = cand_secondary.index[ind_cands[0, k]] # Get original index
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        s = secondary.loc[s_index]
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        dist_km = dists_rad[0, k] * R_earth_km
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Check explicit distance against tolerance
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if dist_km <= cfg.space_tolerance_km:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                row: Dict[str, Any] = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'primary_granule_id': p['primary_granule_id'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'primary_time': p['time'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'primary_lat': p['lat'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'primary_lon': p['lon'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'secondary_granule_id': s['secondary_granule_id'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'secondary_time': s['time'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'secondary_lat': s['lat'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'secondary_lon': s['lon'],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                'distance_km': dist_km,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        'delta_time_sec': np.abs(s['time'].timestamp() - p_time),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # Add variables (using .get for safety)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for v in (cfg.primary_variables or []):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    row[f'primary_{v}'] = p.get(v)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        for v in (cfg.secondary_variables or []):
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    row[f'secondary_{v}'] = s.get(v)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                rows.append(row)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    # 4. Final Output to Parquet
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        result_df = pd.DataFrame(rows)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                # Use PyArrow for optimized columnar output (Parquet)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if not result_df.empty:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                table = pa.Table.from_pandas(result_df)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        pq.write_table(table, output_path)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            else:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        # Ensure an empty but valid Parquet file is written
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                pq.write_table(pa.Table.from_pydict({'empty': pa.array([])}), output_path)
